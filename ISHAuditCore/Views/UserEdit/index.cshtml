@using ISHAudit.Models
@using Newtonsoft.Json
@using ISHAuditCore.Models
@model ISHAuditCore.Controllers.UserEditController
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@{
    ViewBag.Title = "修改人員帳號";
}

@section css{
    <link rel="stylesheet" href="~/css/loading.css">
    <style>
        .size-text {
            font-size: 16px; /* 調整字體大小 */
        }
    </style>
}

@section js{

}

@section page_title{

}

@section location{
<li class="breadcrumb-item" xmlns="http://www.w3.org/1999/html">@Html.ActionLink("首頁", "Index", "Home")</li>
<li class="breadcrumb-item active">@Html.ActionLink("登入", "Index", "Login")</li>
}


@section scripts
{
    <script>
        // 將 JSON 字符串轉換為 JavaScript 對象
        var enterprises = JSON.parse(@Html.Raw(JsonConvert.SerializeObject(ViewBag.EnterpriseJson)));

        // 提取企業名稱
        const enterpriseNames = enterprises.map(ent => ent.Name);

        // 動態提取公司名稱
        function getCompanyNames(enterpriseName) {
            const enterprise = enterprises.find(ent => ent.Name === enterpriseName);
            return enterprise ? enterprise.Child.map(company => company.Name) : [];
        }

        // 動態提取工廠名稱
        function getFactoryNames(companyName, enterpriseName) {
            const enterprise = enterprises.find(ent => ent.Name === enterpriseName);
            if (!enterprise) return [];
            const company = enterprise.Child.find(comp => comp.Name === companyName);
            return company ? company.Child.map(factory => factory.Name) : [];
        }
        
        let gridApi;
        // Grid配置
        const gridOptions = {
            rowData: [],
            columnDefs: [
                { headerName: "排序", field: "id", cellClass: 'size-text', width: 100,editable: false },
                { headerName: "帳號", field: "username", cellClass: 'size-text', width: 100,editable: false },
                { headerName: "名稱", field: "nickname", cellClass: 'size-text', width: 150,editable: true },
                {
                    headerName: "企業",
                    field: "enterpriseName",
                    cellClass: 'size-text',
                    width: 200,
                    editable: true,
                    cellEditor: 'agSelectCellEditor', // 使用下拉選單
                    cellEditorParams: {
                        values: enterpriseNames // 提供所有企業選項
                    },
                    onCellValueChanged: function(params) {
                        // 當企業選擇改變時，更新對應的公司選項
                        const selectedEnterprise = params.data.enterpriseName;
                        const companyOptions = getCompanyNames(selectedEnterprise);
                        gridOptions.api.getColumnDef('companyName').cellEditorParams.values = companyOptions;
                        gridOptions.api.refreshCells({ force: true, columns: ['companyName'] });
                    }
                },
                {
                    headerName: "公司",
                    field: "companyName",
                    cellClass: 'size-text',
                    width: 200,
                    editable: true,
                    cellEditor: 'agSelectCellEditor',
                    cellEditorParams: {
                        values: [] // 初始狀態下公司列表為空，根據企業動態更新
                    },
                    onCellValueChanged: function(params) {
                        // 當公司選擇改變時，更新對應的工廠選項
                        const selectedEnterprise = params.data.enterpriseName;
                        const selectedCompany = params.data.companyName;
                        const factoryOptions = getFactoryNames(selectedCompany, selectedEnterprise);
                        gridOptions.api.getColumnDef('factoryName').cellEditorParams.values = factoryOptions;
                        gridOptions.api.refreshCells({ force: true, columns: ['factoryName'] });
                    }
                },
                {
                    headerName: "工廠",
                    field: "factoryName",
                    cellClass: 'size-text',
                    width: 200,
                    editable: true,
                    cellEditor: 'agSelectCellEditor',
                    cellEditorParams: {
                        values: [] // 初始狀態下工廠列表為空，根據公司動態更新
                    }
                },
                { headerName: "權限", field: "authority", cellClass: 'size-text', width: 600,editable: false,
                    valueGetter: (params) => {
                        try {
                            const data = JSON.parse(params.data.authority);
                            // 自定義你想要的顯示格式
                            return `督導權限: ${data.Audit}, 績效指標權限: ${data.KPI}, 系統權限: ${data.Sys}, 組織權限: ${data.Org}`;
                        } catch (e) {
                            return 'Invalid JSON'; // 若解析失敗，顯示錯誤
                        }
                    }

                },
                {
                    headerName: "修改密碼", width: 150,
                    cellRenderer: function (params) {
                        return `<button type='button' onclick='change_password(${params.data.id});' class='btn btn-success'><b>更改密碼</b></button>`;
                    }
                },
                {
                    headerName: "刪除", width: 150,
                    cellRenderer: function (params) {
                        return `<button type='button' onclick='delete_data(${params.data.id}, "${params.data.username}");' class='btn btn-danger'><b>刪除資料</b></button>`;
                    }
                }
            ],
            onCellValueChanged: onCellValueChanged, // 綁定事件
            defaultColDef: {
                resizable: true,
                sortable: true,
            },
            domLayout: 'autoHeight', // 自適應高度
            pagination: true, // 開啟分頁功能
            paginationPageSize: 15, // 每頁顯示 10 條數據
            rowSelection: 'multiple', // 啟用行選擇
            //domLayout: 'autoHeight', // 動態調整高度
            overlayNoRowsTemplate: '<span class="ag-overlay-loading-center">Not found</span>', // 無數據顯示模板
            onGridReady: function(params) {
                gridApi = params.api; // 獲取 gridApi
            },
            onCellClicked: function(event) {
                if (event.colDef.field === 'enterpriseName' ||event.colDef.field === 'companyName' ||
                    event.colDef.field === 'factoryName') {
                    change_enterprise(event.data.id); // 當點擊權限列時，執行 change_enterprise 函數
                }
                if (event.colDef.field === 'authority') {
                    change_authority(event.data.id); // 當點擊權限列時，執行 change_authority 函數
                }
            },
            getRowId: function(params) {
                return params.data.id; // 假設 'id' 是唯一識別符
            }
        };
        
        $(document).ready(function () {
        
            const gridDiv = document.querySelector('#myGrid');
            gridApi = new agGrid.Grid(gridDiv, gridOptions); 
            
            document.addEventListener('DOMContentLoaded', function () {
                const gridDiv = document.querySelector('#myGrid');
                new agGrid.Grid(gridDiv, gridOptions);
                get();
            });

            


            // 調試輸出數據
            console.log("Enterprises:", enterprises);
            console.log("Companies:", companies);
            console.log("Factories:", factories);
            
          
        });
    
    </script>
}

<!DOCTYPE html>
<html>
<head>
    <title>UserEdit</title>

</head>
<body>

<section>
    <div class="card card-primary">
        <div class="card-header">
            <h3 class="card-title">修改人員帳號</h3>
        </div>
        <br>
        <button class="btn btn-block btn-success" onclick="get()">查詢資料</button>
        <br>
        <div>
            <div id="myGrid" class="card-body ag-theme-quartz" style="width: 100%;"></div>
        </div>
    </div>
</section>

<script>

    function get() {
        $.ajax({
            url: '/UserEdit/GetDataFromDatabase',
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                if (gridApi) { // 確保 gridApi 存在
                    gridApi.setRowData(data); // 使用 gridApi
                } else {
                    console.log("gridApi is not initialized yet");
                }
            },
            error: function (error) {
                console.log("Error fetching data", error);
            }
        });
    }
    
    function onCellValueChanged(event) {
        if (event.oldValue !== event.newValue) {
            console.log('Cell value changed from', event.oldValue, 'to', event.newValue);
            
            $.ajax({
                url: '/UserEdit/UpdateUserField',
                type: 'POST',
                data: {
                    id: event.data.id,
                    field: event.colDef.field, // 被修改的字段
                    value: event.newValue      // 新值
                },
                success: function (response) {
                    Toast.fire({
                        icon: 'success',
                        title: '修改成功'
                    });
                },
                error: function (error) {
                    Toast.fire({
                        icon: 'error',
                        title: '修改失敗'
                    });
                }
            });
        }
    }
    
    function change_password(id){
      $("#remark_modal_password").modal('show');
      $("#item_password").val(id)
    }
    
    function send_change_password() {
        block();
        $.ajax({
            url: '/UserEdit/Newpassword',
            type: "post",
            data: {id:$("#item_password").val(),password: $("#password").val() },
            dataType: "json",
            success: function (data) {
                $("#jsGrid").jsGrid({data:data});
                unblock();
                $("#remark_modal_password").modal('hide');
                if (data.error) {
                    // 顯示錯誤訊息
                    alert(data.error);
                } else if (data.message) {
                    // 顯示成功訊息
                    alert(data.message);
                }
            
            },
            error: function (XMLHttpRequest, textStatus) {
                unblock();
                $("#remark_modal_password").modal('hide');
                Toast.fire({
                    icon: 'error',
                    title: '儲存失敗'
                });
            }
        });
    }
    
    function change_authority(id){
      $("#remark_modal_authority").modal('show');
      $("#item_authority").val(id)
    }
    
    function send_change_authority() {
        block();
        $.ajax({
            url: '/UserEdit/Newauthority',
            type: "post",
            data: {id:$("#item_authority").val(),Audit:$("#Audit").val(),KPI:$("#KPI").val(),Sys:$("#Sys").val(),Org:$("#Org").val() },
            dataType: "json",
            success: function (data) {
                gridApi.setRowData(data);
                unblock();
                $("#remark_modal_authority").modal('hide');
                if (data.error) {
                    // 顯示錯誤訊息
                    alert(data.error);
                } else if (data.message) {
                    // 顯示成功訊息
                    alert(data.message);
                }
                Toast.fire({
                    icon: 'success',
                    title: '儲存成功'
                });
            },
            error: function (XMLHttpRequest, textStatus) {
                unblock();
                $("#remark_modal_authority").modal('hide');
                Toast.fire({
                    icon: 'error',
                    title: '儲存失敗'
                });
            }
        });
    }
    


    
    function delete_data(id,username) {
        const confirmDelete = confirm(`確定要刪除這些資料嗎？\n\n帳號: ${username}`);

        // 如果用戶點擊「確定」，則執行刪除操作
        if (confirmDelete) {
            $.ajax({
                url: '/UserEdit/DeleteData', // 替換為實際的後端API
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify([id]), // 將選中的 ID 以 JSON 格式發送
                success: function(response) {
                    alert(`資料已被刪除。\n刪除的帳號: ${username}`);
                    // 刪除成功後，刷新表格數據或移除選中的行
                    gridOptions.api.applyTransaction({ remove: [{ id: id }] });
                },
                error: function(error) {
                    console.log('刪除失敗', error);
                    alert('刪除過程中出現錯誤，請稍後再試。');
                }
            });

        }
    }
</script>
@* 更改密碼 *@
<div class="modal fade" id="remark_modal_password">
    <div class="modal-dialog">
        <div class="modal-content bg-default">
            <div class="modal-header">
                <h4 class="modal-title">請輸入新的密碼</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="input-group mb-3">
                        <input id="item_password" type="hidden"/>
                        <input type="password" class="form-control" id="password" name="password" placeholder="Password">
                        <div class="input-group-append">
                            <div class="input-group-text">
                                <span class="fas fa-lock"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button>
                <button type="button" class="btn btn btn-primary" onclick="send_change_password()"> 保存 </button>
            </div>
        </div>
    </div>
</div>

<!-- 更改權限 -->
<div class="modal fade" id="remark_modal_authority">
    <div class="modal-dialog">
        <div class="modal-content bg-default">
            <div class="modal-header">
                <h4 class="modal-title">請選擇新的權限</h4>
                <input id="item_authority" type="hidden"/>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="form-group">
                            <label class="form-label">Audit權限：</label>
                            <select class="form-select" name="Audit" id="Audit">
                                <option value="admin">Admin</option>
                                <option value="power">Power</option>
                                <option value="operator">Operator</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <div class="form-group">
                            <label class="form-label">KPI權限：</label>
                            <select class="form-select" name="KPI" id="KPI">
                                <option value="admin">Admin</option>
                                <option value="power">Power</option>
                                <option value="operator">Operator</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <div class="form-group">
                            <label class="form-label">Sys權限：</label>
                            <select class="form-select" name="Sys" id="Sys">
                                <option value="admin">Admin</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <div class="form-group">
                            <label class="form-label">Org權限：</label>
                            <select class="form-select" name="Org" id="Org">
                                <option value="admin">Admin</option>
                                <option value="factory">Factory</option>
                                <option value="manager">Manager</option>
                                <option value="enterprise">Enterprise</option>
                                <option value="company">Company</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button>
                <button type="button" class="btn btn btn-primary" onclick="send_change_authority()"> 保存 </button>
            </div>
        </div>
    </div>
</div>

<!-- 企業、公司、工廠 -->

<div class="modal fade" id="remark_modal_enterprise" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <input id="item_enterprise" type="hidden"/>
                <h5 class="modal-title" id="myModalLabel">選擇選項</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- 将你的下拉选择框放在这里 -->
                <div class="mb-3">
                    <label for="enterprise_id" class="form-label">企業：</label>
                    <select id="enterprise_id" name="enterprise_id" class="form-control select2" style="width: 100%;">
                        @* 企業選項將由 JavaScript 動態更新 *@
                    </select>
                </div>

                <div class="mb-3">
                    <label for="company_id" class="form-label">公司：</label>
                    <select id="company_id" name="company_id" class="form-control select2" style="width: 100%;">
                        @* 公司選項將由 JavaScript 動態更新 *@
                    </select>
                </div>

                <div class="mb-3">
                    <label for="factory_id" class="form-label">工廠：</label>
                    <select id="factory_id" name="factory_id" class="form-control select2" style="width: 100%;">
                        @* 工廠選項將由 JavaScript 動態更新 *@
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">關閉</button>
                <button type="button" class="btn btn-primary" onclick="send_change_enterprise()">保存</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>